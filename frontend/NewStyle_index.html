<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ä¼šè®®è½¬å½• Â· å‰ç«¯</title>
    <style>
      :root {
        --primary: #FF4B4B;
        --primary-light: #FF9A9A;
        --primary-dark: #D32F2F;
        --secondary: #1E88E5;
        --bg: #f8f9fa;
        --card: #ffffff;
        --text: #24292e;
        --text-light: #6a737d;
        --border: #e1e4e8;
        --success: #28a745;
        --warning: #ffd33d;
        --error: #d73a49;
        --processing: #0366d6;
        --sidebar-width: 280px;
      }
      
      * { 
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
        background-color: var(--bg);
        color: var(--text);
        line-height: 1.6;
        display: flex;
        min-height: 100vh;
      }
      
      /* ä¾§è¾¹æ æ ·å¼ */
      .sidebar {
        width: var(--sidebar-width);
        background: var(--card);
        border-right: 1px solid var(--border);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }
      
      .logo {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border);
      }
      
      .logo-icon {
        width: 40px;
        height: 40px;
        background: var(--primary);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
      }
      
      .logo-text {
        font-weight: 600;
        font-size: 1.1rem;
      }
      
      .sidebar-section {
        margin-bottom: 2rem;
      }
      
      .sidebar-title {
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-light);
        margin-bottom: 1rem;
      }
      
      .task-status {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      
      .status-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: #fafbfc;
        border-radius: 6px;
        border-left: 4px solid var(--border);
        transition: all 0.3s ease;
      }
      
      .status-item.pending {
        border-left-color: var(--processing);
        background: #f1f8ff;
      }
      
      .status-item.active {
        border-left-color: var(--processing);
        background: #f1f8ff;
      }
      
      .status-item.done {
        border-left-color: var(--success);
        background: #f0fff4;
      }
      
      .status-item.error {
        border-left-color: var(--error);
        background: #ffeef0;
      }
      
      .status-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: var(--border);
        color: white;
        font-size: 0.8rem;
        transition: all 0.3s ease;
      }
      
      .status-item.pending .status-icon {
        background: var(--processing);
      }
      
      .status-item.active .status-icon {
        background: var(--processing);
      }
      
      .status-item.done .status-icon {
        background: var(--success);
      }
      
      .status-item.error .status-icon {
        background: var(--error);
      }
      
      .status-text {
        flex: 1;
      }
      
      .status-label {
        font-size: 0.85rem;
        font-weight: 500;
      }
      
      .status-desc {
        font-size: 0.75rem;
        color: var(--text-light);
      }
      
      .progress-container {
        width: 100%;
        height: 6px;
        background: var(--border);
        border-radius: 3px;
        margin-top: 0.5rem;
        overflow: hidden;
      }
      
      .progress-bar {
        height: 100%;
        background: var(--primary);
        border-radius: 3px;
        transition: width 0.5s ease;
        width: 0%;
      }
      
      /* ä¸»å†…å®¹åŒºæ ·å¼ */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      
      .tabs {
        display: flex;
        background: var(--card);
        border-bottom: 1px solid var(--border);
        padding: 0 1.5rem;
      }
      
      .tab {
        padding: 1rem 1.5rem;
        background: none;
        border: none;
        font-size: 0.95rem;
        font-weight: 500;
        color: var(--text-light);
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
      }
      
      .tab:hover {
        color: var(--text);
      }
      
      .tab.active {
        color: var(--primary);
        font-weight: 600;
      }
      
      .tab.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--primary);
      }
      
      .tab-content {
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
      }
      
      .tab-pane {
        display: none;
        max-width: 900px;
      }
      
      .tab-pane.active {
        display: block;
      }
      
      /* å¡ç‰‡æ ·å¼ */
      .card {
        background: var(--card);
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(27, 31, 35, 0.1);
        margin-bottom: 1.5rem;
        overflow: hidden;
      }
      
      .card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border);
        font-weight: 600;
      }
      
      .card-body {
        padding: 1.5rem;
      }
      
      /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
      .drop-area {
        border: 2px dashed var(--border);
        border-radius: 6px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: #fafbfc;
      }
      
      .drop-area:hover, .drop-area.dragover {
        border-color: var(--primary);
        background: #fff5f5;
      }
      
      .drop-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: var(--text-light);
      }
      
      .file-info {
        margin-top: 1rem;
        padding: 1rem;
        background: #f6f8fa;
        border-radius: 6px;
        text-align: left;
      }
      
      .file-name {
        font-weight: 500;
        margin-bottom: 0.25rem;
      }
      
      .file-size {
        font-size: 0.85rem;
        color: var(--text-light);
      }
      
      /* è¡¨å•å…ƒç´  */
      .form-group {
        margin-bottom: 1.5rem;
      }
      
      .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }
      
      .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 0.95rem;
        transition: border-color 0.2s;
      }
      
      .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(255, 75, 75, 0.1);
      }
      
      /* é€‰é¡¹åˆ‡æ¢ */
      .options-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      
      .option-toggle {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .option-toggle:hover {
        border-color: var(--primary-light);
      }
      
      .option-toggle.active {
        border-color: var(--primary);
        background: #fff5f5;
      }
      
      .option-toggle.required {
        border-color: var(--primary);
        background: #fff5f5;
        cursor: not-allowed;
      }
      
      .option-toggle.required:hover {
        border-color: var(--primary);
      }
      
      .option-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        background: var(--border);
        color: var(--text);
      }
      
      .option-toggle.active .option-icon {
        background: var(--primary);
        color: white;
      }
      
      .option-toggle.required .option-icon {
        background: var(--primary);
        color: white;
      }
      
      .option-text {
        flex: 1;
      }
      
      .option-label {
        font-weight: 500;
        font-size: 0.9rem;
      }
      
      .option-desc {
        font-size: 0.8rem;
        color: var(--text-light);
      }
      
      /* æŒ‰é’® */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .btn:hover:not(:disabled) {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }
      
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      
      .btn-block {
        display: block;
        width: 100%;
        text-align: center;
        justify-content: center;
      }
      
      /* å¤„ç†è¿‡ç¨‹æ ·å¼ */
      .process-log {
        background: #f6f8fa;
        border-radius: 6px;
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        font-size: 0.85rem;
      }
      
      .log-entry {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        border-radius: 3px;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
      }
      
      .log-time {
        color: var(--text-light);
        font-size: 0.75rem;
        min-width: 80px;
      }
      
      .log-message {
        flex: 1;
      }
      
      .log-success {
        background: #dcffe4;
        border-left: 3px solid var(--success);
      }
      
      .log-error {
        background: #ffdce0;
        border-left: 3px solid var(--error);
      }
      
      .log-info {
        background: #dbedff;
        border-left: 3px solid var(--processing);
      }
      
      .log-warning {
        background: #fff5b1;
        border-left: 3px solid var(--warning);
      }
      
      /* è¾“å‡ºæ ·å¼ - Typoraé£æ ¼ */
      .output-section {
        margin-bottom: 2rem;
      }
      
      .output-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
      }
      
      .output-title {
        font-weight: 600;
        font-size: 1.1rem;
      }
      
      .output-content {
        background: var(--card);
        border-radius: 6px;
        padding: 2rem;
        border: 1px solid var(--border);
        max-height: 400px;
        overflow-y: auto;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
        line-height: 1.7;
      }
      
      /* Typoraæ ·å¼æ¸²æŸ“ */
      .typora-content {
        font-size: 16px;
        color: #24292e;
      }
      
      .typora-content h1,
      .typora-content h2,
      .typora-content h3,
      .typora-content h4,
      .typora-content h5,
      .typora-content h6 {
        margin-top: 24px;
        margin-bottom: 16px;
        font-weight: 600;
        line-height: 1.25;
      }
      
      .typora-content h1 {
        font-size: 2em;
        padding-bottom: 0.3em;
        border-bottom: 1px solid #eaecef;
      }
      
      .typora-content h2 {
        font-size: 1.5em;
        padding-bottom: 0.3em;
        border-bottom: 1px solid #eaecef;
      }
      
      .typora-content h3 {
        font-size: 1.25em;
      }
      
      .typora-content h4 {
        font-size: 1em;
      }
      
      .typora-content p {
        margin-top: 0;
        margin-bottom: 16px;
      }
      
      .typora-content ul,
      .typora-content ol {
        padding-left: 2em;
        margin-top: 0;
        margin-bottom: 16px;
      }
      
      .typora-content li {
        margin-bottom: 0.25em;
      }
      
      .typora-content ul ul,
      .typora-content ul ol,
      .typora-content ol ol,
      .typora-content ol ul {
        margin-top: 0;
        margin-bottom: 0;
      }
      
      .typora-content blockquote {
        padding: 0 1em;
        color: #6a737d;
        border-left: 0.25em solid #dfe2e5;
        margin: 0 0 16px 0;
      }
      
      .typora-content table {
        border-spacing: 0;
        border-collapse: collapse;
        margin-bottom: 16px;
        width: 100%;
      }
      
      .typora-content table th,
      .typora-content table td {
        padding: 6px 13px;
        border: 1px solid #dfe2e5;
      }
      
      .typora-content table th {
        font-weight: 600;
        background-color: #f6f8fa;
      }
      
      .typora-content table tr:nth-child(2n) {
        background-color: #f6f8fa;
      }
      
      .typora-content code {
        padding: 0.2em 0.4em;
        margin: 0;
        font-size: 85%;
        background-color: rgba(27, 31, 35, 0.05);
        border-radius: 3px;
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      }
      
      .typora-content pre {
        padding: 16px;
        overflow: auto;
        font-size: 85%;
        line-height: 1.45;
        background-color: #f6f8fa;
        border-radius: 3px;
        margin-bottom: 16px;
      }
      
      .typora-content pre code {
        padding: 0;
        background: transparent;
        border-radius: 0;
      }
      
      .typora-content hr {
        height: 0.25em;
        padding: 0;
        margin: 24px 0;
        background-color: #e1e4e8;
        border: 0;
      }
      
      .typora-content strong {
        font-weight: 600;
      }
      
      .typora-content em {
        font-style: italic;
      }
      
      .download-buttons {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1rem;
      }
      
      .download-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 6px;
        text-decoration: none;
        color: var(--text);
        font-size: 0.85rem;
        transition: all 0.2s;
      }
      
      .download-btn:hover {
        background: #f6f8fa;
        border-color: var(--primary-light);
      }
      
      /* éšè—å…ƒç´  */
      .hidden {
        display: none;
      }
      
      /* è°ƒè¯•æ ·å¼ */
      .debug-border {
        border: 2px solid red !important;
      }
      
      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        body {
          flex-direction: column;
        }
        
        .sidebar {
          width: 100%;
          border-right: none;
          border-bottom: 1px solid var(--border);
        }
        
        .tabs {
          overflow-x: auto;
        }
        
        .options-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
      <div class="logo">
        <div class="logo-icon">M</div>
        <div class="logo-text">ä¼šè®®è½¬å½•</div>
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-title">å¤„ç†çŠ¶æ€</div>
        <div class="task-status">
          <div class="status-item active" id="status-upload">
            <div class="status-icon">1</div>
            <div class="status-text">
              <div class="status-label">æ–‡ä»¶ä¸Šä¼ </div>
              <div class="status-desc">ç­‰å¾…ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶</div>
            </div>
          </div>
          
          <div class="status-item" id="status-transcribe">
            <div class="status-icon">2</div>
            <div class="status-text">
              <div class="status-label">è¯­éŸ³è½¬å½•</div>
              <div class="status-desc">å°†éŸ³é¢‘è½¬æ¢ä¸ºæ–‡æœ¬</div>
            </div>
          </div>
          
          <div class="status-item" id="status-summary">
            <div class="status-icon">3</div>
            <div class="status-text">
              <div class="status-label">ç”Ÿæˆæ‘˜è¦</div>
              <div class="status-desc">æå–ä¼šè®®æ ¸å¿ƒå†…å®¹</div>
            </div>
          </div>
          
          <div class="status-item" id="status-keypoints">
            <div class="status-icon">4</div>
            <div class="status-text">
              <div class="status-label">æå–è¦ç‚¹</div>
              <div class="status-desc">è¯†åˆ«å…³é”®è®¨è®ºç‚¹</div>
            </div>
          </div>
          
          <div class="status-item" id="status-terms">
            <div class="status-icon">5</div>
            <div class="status-text">
              <div class="status-label">æœ¯è¯­è§£é‡Š</div>
              <div class="status-desc">è§£æä¸“ä¸šæœ¯è¯­</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-title">å¤„ç†è¿›åº¦</div>
        <div class="progress-container">
          <div class="progress-bar" id="sidebar-progress-bar"></div>
        </div>
        <div class="status-desc" id="progress-text" style="margin-top: 0.5rem;">0%</div>
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-title">å½“å‰æ–‡ä»¶</div>
        <div class="status-desc" id="current-file">æœªé€‰æ‹©æ–‡ä»¶</div>
      </div>
    </div>
    
    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
      <!-- é€‰é¡¹å¡å¯¼èˆª -->
      <div class="tabs">
        <button class="tab active" data-tab="input">è¾“å…¥</button>
        <button class="tab" data-tab="process">å¤„ç†è¿‡ç¨‹</button>
        <button class="tab" data-tab="output">è¾“å‡º</button>
      </div>
      
      <!-- é€‰é¡¹å¡å†…å®¹ -->
      <div class="tab-content">
        <!-- è¾“å…¥é€‰é¡¹å¡ -->
        <div id="input-tab" class="tab-pane active">
          <div class="card">
            <div class="card-header">ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶</div>
            <div class="card-body">
              <div id="drop-area" class="drop-area">
                <div class="drop-icon">ğŸ¤</div>
                <h3>æ‹–æ”¾æˆ–ç‚¹å‡»ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶</h3>
                <p>æ”¯æŒ MP3ã€WAV ç­‰å¸¸è§éŸ³é¢‘æ ¼å¼</p>
                <input type="file" id="file-input" class="hidden" accept="audio/*" />
                <div id="file-info" class="file-info hidden">
                  <div class="file-name" id="file-name"></div>
                  <div class="file-size" id="file-size"></div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">ä¼šè®®ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label" for="attendees">å‚ä¼šäººå‘˜</label>
                <input type="text" id="attendees" class="form-control" placeholder="è¾“å…¥å‚ä¼šäººå‘˜ï¼Œç”¨é€—å·åˆ†éš”" />
              </div>
              
              <div class="form-group">
                <label class="form-label" for="meeting-topic">ä¼šè®®ä¸»é¢˜</label>
                <input type="text" id="meeting-topic" class="form-control" placeholder="è¾“å…¥ä¼šè®®ä¸»é¢˜æˆ–è®®é¢˜" />
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">å¤„ç†é€‰é¡¹</div>
            <div class="card-body">
              <div class="options-grid">
                <!-- å®Œæ•´è½¬å½• - å¿…éœ€åŠŸèƒ½ï¼Œä¸å¯å–æ¶ˆ -->
                <div class="option-toggle required" id="toggle-minutes">
                  <div class="option-icon">ğŸ“„</div>
                  <div class="option-text">
                    <div class="option-label">å®Œæ•´è½¬å½•</div>
                    <div class="option-desc">ç”Ÿæˆå®Œæ•´ä¼šè®®è®°å½•ï¼ˆå¿…éœ€ï¼‰</div>
                  </div>
                </div>
                
                <div class="option-toggle active" id="toggle-summary">
                  <div class="option-icon">ğŸ“</div>
                  <div class="option-text">
                    <div class="option-label">ç”Ÿæˆæ‘˜è¦</div>
                    <div class="option-desc">ä¼šè®®æ ¸å¿ƒå†…å®¹æ€»ç»“</div>
                  </div>
                </div>
                
                <div class="option-toggle" id="toggle-keypoints">
                  <div class="option-icon">ğŸ”</div>
                  <div class="option-text">
                    <div class="option-label">å…³é”®è¦ç‚¹</div>
                    <div class="option-desc">æå–é‡è¦è®¨è®ºç‚¹</div>
                  </div>
                </div>
                
                <div class="option-toggle" id="toggle-terms">
                  <div class="option-icon">ğŸ’¡</div>
                  <div class="option-text">
                    <div class="option-label">æœ¯è¯­è§£é‡Š</div>
                    <div class="option-desc">è§£æä¸“ä¸šæœ¯è¯­</div>
                  </div>
                </div>
              </div>
              
              <button id="submit-btn" class="btn btn-block">å¼€å§‹å¤„ç†</button>
            </div>
          </div>
        </div>
        
        <!-- å¤„ç†è¿‡ç¨‹é€‰é¡¹å¡ -->
        <div id="process-tab" class="tab-pane">
          <div class="card">
            <div class="card-header">å¤„ç†æ—¥å¿—</div>
            <div class="card-body">
              <div id="process-log" class="process-log">
                <div class="log-entry log-info">
                  <div class="log-time" id="current-time"></div>
                  <div class="log-message">ç­‰å¾…å¼€å§‹å¤„ç†...</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- è¾“å‡ºé€‰é¡¹å¡ -->
        <div id="output-tab" class="tab-pane">
          <div class="output-section">
            <div class="output-header">
              <div class="output-title">å®Œæ•´è½¬å½•</div>
              <div id="transcript-status" class="status-desc">ç­‰å¾…å¤„ç†</div>
            </div>
            <div id="transcript-content" class="output-content typora-content">ï¼ˆç­‰å¾…å¤„ç†ç»“æœï¼‰</div>
            <div id="transcript-downloads" class="download-buttons"></div>
          </div>
          
          <div class="output-section">
            <div class="output-header">
              <div class="output-title">ä¼šè®®æ‘˜è¦</div>
              <div id="summary-status" class="status-desc">ç­‰å¾…å¤„ç†</div>
            </div>
            <div id="summary-content" class="output-content typora-content">ï¼ˆç­‰å¾…å¤„ç†ç»“æœï¼‰</div>
            <div id="summary-downloads" class="download-buttons"></div>
          </div>
          
          <div class="output-section">
            <div class="output-header">
              <div class="output-title">å…³é”®è¦ç‚¹</div>
              <div id="keypoints-status" class="status-desc">æœªé€‰æ‹©æ­¤é€‰é¡¹</div>
            </div>
            <div id="keypoints-content" class="output-content typora-content">ï¼ˆå¦‚é€‰æ‹©"å…³é”®è¦ç‚¹"é€‰é¡¹ï¼Œæ­¤å¤„å°†æ˜¾ç¤ºæå–ç»“æœï¼‰</div>
            <div id="keypoints-downloads" class="download-buttons"></div>
          </div>
          
          <div class="output-section">
            <div class="output-header">
              <div class="output-title">ä¸“ä¸šæœ¯è¯­</div>
              <div id="terms-status" class="status-desc">æœªé€‰æ‹©æ­¤é€‰é¡¹</div>
            </div>
            <div id="terms-content" class="output-content typora-content">ï¼ˆå¦‚é€‰æ‹©"æœ¯è¯­è§£é‡Š"é€‰é¡¹ï¼Œæ­¤å¤„å°†æ˜¾ç¤ºè§£æç»“æœï¼‰</div>
            <div id="terms-downloads" class="download-buttons"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
         // ==================== å·¥å…·ç±» ====================
      
      // ç®€åŒ–çš„ Typora æ¸²æŸ“å™¨
      class TyporaRenderer {
        static render(text) {
          if (!text) return '';
          
          let html = this.escapeHtml(text);
          
          // å¤„ç†ä»£ç å—
          html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
          html = html.replace(/`([^`\n]+?)`/g, '<code>$1</code>');
          
          // å¤„ç†ç²—ä½“å’Œæ–œä½“
          html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
          html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
          
          // å¤„ç†æ ‡é¢˜
          html = html.replace(/^#{1,6}\s+(.*)$/gm, (match, p1) => {
            const level = match.match(/^#+/)[0].length;
            return `<h${level}>${p1}</h${level}>`;
          });
          
          // å¤„ç†åˆ—è¡¨
          html = html.replace(/^[-*+]\s+(.*)$/gm, '<li>$1</li>');
          html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
          
          // å¤„ç†æ®µè½
          const lines = html.split('\n');
          const result = [];
          let currentParagraph = [];
          
          for (const line of lines) {
            if (line.trim() === '') {
              if (currentParagraph.length > 0) {
                result.push(`<p>${currentParagraph.join('<br>')}</p>`);
                currentParagraph = [];
              }
              result.push('');
            } else if (!line.startsWith('<')) {
              currentParagraph.push(line);
            } else {
              if (currentParagraph.length > 0) {
                result.push(`<p>${currentParagraph.join('<br>')}</p>`);
                currentParagraph = [];
              }
              result.push(line);
            }
          }
          
          if (currentParagraph.length > 0) {
            result.push(`<p>${currentParagraph.join('<br>')}</p>`);
          }
          
          return result.filter(line => line !== '').join('\n');
        }
        
        static escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
      }

      // åº”ç”¨çŠ¶æ€ç®¡ç†
      class AppState {
        constructor() {
          this.reset();
        }
        
        reset() {
          this.currentProgress = 0;
          this.eventSource = null;
          this.currentFile = null;
          this.currentTaskId = null;
          this.currentOptions = {};
        }
      }

      // ==================== æ ¸å¿ƒ UI ç®¡ç†å™¨ ====================
      
      class UIManager {
        constructor() {
          if (window.uiManager) {
            return window.uiManager;
          }
          
          this.appState = new AppState();
          this.isInitialized = false;
          this.elements = {};
          this.config = this.getConfig();
          
          window.uiManager = this;
          this.initialize();
        }
        
        // é…ç½®å¸¸é‡
        getConfig() {
          return {
            stageWeights: { upload: 10, transcribe: 40, summary: 25, keypoints: 15, terms: 10 },
            stageLabels: { transcript: 'å®Œæ•´è½¬å½•', summary: 'ç”Ÿæˆæ‘˜è¦', keypoints: 'å…³é”®è¦ç‚¹', terms: 'æœ¯è¯­è§£é‡Š' },
            requiredStages: ['upload', 'transcribe'],
            elementSelectors: {
              // é€‰é¡¹å¡
              tabs: '.tab',
              tabPanes: '.tab-pane',
              
              // æ–‡ä»¶ä¸Šä¼ 
              dropArea: '#drop-area',
              fileInput: '#file-input',
              fileInfo: '#file-info',
              fileName: '#file-name', 
              fileSize: '#file-size',
              currentFile: '#current-file',
              
              // é€‰é¡¹åˆ‡æ¢
              optionToggles: '.option-toggle',
              toggleSummary: '#toggle-summary',
              toggleKeypoints: '#toggle-keypoints', 
              toggleTerms: '#toggle-terms',
              
              // æŒ‰é’®
              submitBtn: '#submit-btn',
              
              // çŠ¶æ€æ˜¾ç¤º
              statusUpload: '#status-upload',
              statusTranscribe: '#status-transcribe',
              statusSummary: '#status-summary', 
              statusKeypoints: '#status-keypoints',
              statusTerms: '#status-terms',
              
              // è¾“å‡ºåŒºåŸŸ
              outputStatus: {
                transcript: '#transcript-status',
                summary: '#summary-status', 
                keypoints: '#keypoints-status',
                terms: '#terms-status'
              },
              
              outputContent: {
                transcript: '#transcript-content',
                summary: '#summary-content',
                keypoints: '#keypoints-content', 
                terms: '#terms-content'
              },
              
              // è¿›åº¦ç›¸å…³
              progressBar: '#sidebar-progress-bar',
              progressText: '#progress-text',
              
              // æ—¥å¿—ç›¸å…³
              processLog: '#process-log',
              currentTime: '#current-time',
              
              // ä¸‹è½½æŒ‰é’®
              downloadContainers: {
                transcript: '#transcript-downloads',
                summary: '#summary-downloads',
                keypoints: '#keypoints-downloads',
                terms: '#terms-downloads'
              }
            }
          };
        }
        
        // åˆå§‹åŒ–
        async initialize() {
          try {
            if (document.readyState === 'loading') {
              await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve));
            }
            
            this.cacheElements();
            this.setupEventListeners();
            this.updateCurrentTime();
            this.updateUI();
            
            this.isInitialized = true;
            console.log('âœ… UIç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
          } catch (error) {
            console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
          }
        }
        
        // ç¼“å­˜DOMå…ƒç´ 
        cacheElements() {
          const selectors = this.config.elementSelectors;
          
          // ç¼“å­˜ç®€å•å…ƒç´ 
          Object.keys(selectors).forEach(key => {
            if (typeof selectors[key] === 'string') {
              this.elements[key] = document.querySelector(selectors[key]);
            }
          });
          
          // ç¼“å­˜èŠ‚ç‚¹åˆ—è¡¨
          this.elements.tabs = document.querySelectorAll(selectors.tabs);
          this.elements.tabPanes = document.querySelectorAll(selectors.tabPanes);
          this.elements.optionToggles = document.querySelectorAll(selectors.optionToggles);
          
          // ç¼“å­˜å¤æ‚ç»“æ„
          this.elements.statusElements = {
            upload: document.querySelector(selectors.statusUpload),
            transcribe: document.querySelector(selectors.statusTranscribe),
            summary: document.querySelector(selectors.statusSummary),
            keypoints: document.querySelector(selectors.statusKeypoints),
            terms: document.querySelector(selectors.statusTerms)
          };
          
          this.elements.outputStatus = {};
          this.elements.outputContent = {};
          this.elements.downloadContainers = {};
          
          Object.keys(selectors.outputStatus).forEach(key => {
            this.elements.outputStatus[key] = document.querySelector(selectors.outputStatus[key]);
            this.elements.outputContent[key] = document.querySelector(selectors.outputContent[key]);
            this.elements.downloadContainers[key] = document.querySelector(selectors.downloadContainers[key]);
          });
        }
        
        // äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
        setupEventListeners() {
          // é€‰é¡¹å¡åˆ‡æ¢
          this.elements.tabs.forEach(tab => {
            tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
          });
          
          // æ–‡ä»¶ä¸Šä¼ 
          const { dropArea, fileInput } = this.elements;
          ['dragenter', 'dragover'].forEach(evt => {
            dropArea.addEventListener(evt, e => this.handleDrag(e, true));
          });
          ['dragleave', 'drop'].forEach(evt => {
            dropArea.addEventListener(evt, e => this.handleDrag(e, false));
          });
          dropArea.addEventListener('drop', e => this.handleFileDrop(e));
          dropArea.addEventListener('click', () => fileInput.click());
          fileInput.addEventListener('change', () => this.handleFileSelect());
          
          // é€‰é¡¹åˆ‡æ¢
          this.elements.optionToggles.forEach(toggle => {
            if (!toggle.classList.contains('required')) {
              toggle.addEventListener('click', () => this.toggleOption(toggle));
            }
          });
          
          // æäº¤æŒ‰é’®
          this.elements.submitBtn.addEventListener('click', () => this.handleSubmit());
          
          // æ—¶é—´æ›´æ–°
          setInterval(() => this.updateCurrentTime(), 1000);
        }
        
        // ==================== æ ¸å¿ƒåŠŸèƒ½æ–¹æ³• ====================
        
        // é€‰é¡¹å¡åˆ‡æ¢
        switchTab(tabId) {
          // æ›´æ–°é€‰é¡¹å¡
          this.elements.tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabId));
          
          // æ›´æ–°å†…å®¹
          this.elements.tabPanes.forEach(pane => {
            pane.classList.toggle('active', pane.id === `${tabId}-tab`);
          });
        }
        
        // æ–‡ä»¶å¤„ç†
        handleDrag(e, isOver) {
          e.preventDefault();
          this.elements.dropArea.classList.toggle('dragover', isOver);
        }
        
        handleFileDrop(e) {
          e.preventDefault();
          if (e.dataTransfer.files.length) {
            this.elements.fileInput.files = e.dataTransfer.files;
            this.handleFileSelect();
          }
        }
        
        handleFileSelect() {
          const { fileInput, fileInfo, fileName, fileSize, currentFile } = this.elements;
          
          if (fileInput.files.length) {
            const file = fileInput.files[0];
            this.appState.currentFile = file;
            
            fileName.textContent = file.name;
            fileSize.textContent = this.formatFileSize(file.size);
            currentFile.textContent = file.name;
            fileInfo.classList.remove('hidden');
          } else {
            fileInfo.classList.add('hidden');
            currentFile.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
            this.appState.currentFile = null;
          }
        }
        
        // é€‰é¡¹åˆ‡æ¢
        toggleOption(toggle) {
          toggle.classList.toggle('active');
          this.updateUI();
        }
        
        // æ›´æ–°ç•Œé¢çŠ¶æ€
        updateUI() {
          const options = this.getCurrentOptions();
          this.updateStatusDisplay(options);
          this.updateOutputDisplay(options);
          this.appState.currentOptions = options;
        }
        
        getCurrentOptions() {
          return {
            summary: this.elements.toggleSummary.classList.contains('active'),
            keypoints: this.elements.toggleKeypoints.classList.contains('active'),
            terms: this.elements.toggleTerms.classList.contains('active')
          };
        }
        
        updateStatusDisplay(options) {
          // å¿…éœ€åŠŸèƒ½å§‹ç»ˆå¯ç”¨
          this.config.requiredStages.forEach(stage => {
            const element = this.elements.statusElements[stage];
            if (element) {
              element.classList.add('pending');
              element.style.opacity = '1';
            }
          });
          
          // å¯é€‰åŠŸèƒ½æ ¹æ®é€‰æ‹©çŠ¶æ€æ›´æ–°
          Object.keys(options).forEach(stage => {
            const element = this.elements.statusElements[stage];
            if (element) {
              element.classList.toggle('pending', options[stage]);
              element.style.opacity = options[stage] ? '1' : '0.6';
            }
          });
        }
        
        updateOutputDisplay(options) {
          // å®Œæ•´è½¬å½•å§‹ç»ˆå¯ç”¨
          this.updateOutputSection('transcript', true);
          
          // å¯é€‰åŠŸèƒ½æ ¹æ®é€‰æ‹©çŠ¶æ€æ›´æ–°
          Object.keys(options).forEach(section => {
            this.updateOutputSection(section, options[section]);
          });
        }
        
        updateOutputSection(section, isEnabled) {
          const statusElement = this.elements.outputStatus[section];
          const contentElement = this.elements.outputContent[section];
          
          if (statusElement && contentElement) {
            if (isEnabled) {
              statusElement.textContent = 'ç­‰å¾…å¤„ç†';
              statusElement.style.color = '';
              contentElement.innerHTML = 'ï¼ˆç­‰å¾…å¤„ç†ç»“æœï¼‰';
              contentElement.style.opacity = '1';
            } else {
              statusElement.textContent = 'æœªé€‰æ‹©æ­¤åŠŸèƒ½';
              statusElement.style.color = 'var(--text-light)';
              contentElement.innerHTML = `ï¼ˆå¦‚é€‰æ‹©"${this.config.stageLabels[section]}"é€‰é¡¹ï¼Œæ­¤å¤„å°†æ˜¾ç¤ºå¤„ç†ç»“æœï¼‰`;
              contentElement.style.opacity = '0.6';
            }
          }
        }
        
        // è¿›åº¦ç®¡ç†
        updateProgress(percent) {
          if (this.elements.progressBar) {
            this.elements.progressBar.style.width = `${percent}%`;
          }
          if (this.elements.progressText) {
            this.elements.progressText.textContent = `${percent}%`;
          }
        }
        
        // æ—¥å¿—ç®¡ç†
        addLog(message, type = 'info') {
          const logContainer = this.elements.processLog;
          if (!logContainer) return;
          
          const now = new Date();
          const timeString = now.toTimeString().split(' ')[0];
          
          const logEntry = document.createElement('div');
          logEntry.className = `log-entry log-${type}`;
          logEntry.innerHTML = `
            <div class="log-time">${timeString}</div>
            <div class="log-message">${message}</div>
          `;
          
          logContainer.appendChild(logEntry);
          logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // ==================== è¡¨å•æäº¤å’Œå¤„ç† ====================
        
        async handleSubmit() {
          const { submitBtn, fileInput } = this.elements;
          
          if (!this.validateFileInput()) return;
          
          submitBtn.disabled = true;
          submitBtn.textContent = 'å¤„ç†ä¸­...';
          
          this.resetUI();
          this.switchTab('process');
          this.addLog('å¼€å§‹å¤„ç†éŸ³é¢‘æ–‡ä»¶...');
          
          try {
            const formData = this.createFormData();
            const response = await fetch('/api/process', { method: 'POST', body: formData });
            
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            this.appState.currentTaskId = data.task_id;
            this.addLog(`ä»»åŠ¡å·²åˆ›å»ºï¼ŒID: ${data.task_id}`, 'success');
            
            this.connectToEventStream(data.task_id);
          } catch (error) {
            this.addLog(`å¤„ç†å¤±è´¥: ${error.message}`, 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'å¼€å§‹å¤„ç†';
          }
        }
        
        validateFileInput() {
          if (!this.elements.fileInput.files.length) {
            alert('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶');
            return false;
          }
          return true;
        }
        
        createFormData() {
          const formData = new FormData();
          formData.append('file', this.elements.fileInput.files[0]);
          formData.append('attendees', document.getElementById('attendees').value || '');
          formData.append('meeting_topic', document.getElementById('meeting-topic').value || '');
          formData.append('generate_summary', this.elements.toggleSummary.classList.contains('active'));
          formData.append('generate_minutes', true);
          formData.append('generate_keypoints', this.elements.toggleKeypoints.classList.contains('active'));
          formData.append('generate_terms', this.elements.toggleTerms.classList.contains('active'));
          
          return formData;
        }
        
        // ==================== SSE äº‹ä»¶å¤„ç† ====================
        
        connectToEventStream(taskId) {
          if (this.appState.eventSource) {
            this.appState.eventSource.close();
          }
          
          this.appState.eventSource = new EventSource(`/api/events/${taskId}`);
          
          this.appState.eventSource.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              this.handleEventData(data);
            } catch (error) {
              this.addLog('æ¥æ”¶æ•°æ®æ ¼å¼é”™è¯¯', 'error');
            }
          };
          
          this.appState.eventSource.onerror = (error) => {
            this.addLog('è¿æ¥é”™è¯¯ï¼Œå°è¯•é‡æ–°è¿æ¥...', 'error');
            setTimeout(() => {
              if (this.appState.currentTaskId) {
                this.connectToEventStream(this.appState.currentTaskId);
              }
            }, 5000);
          };
        }
        
        handleEventData(data) {
          if (data.stage && data.status) {
            this.handleStageUpdate(data);
          }
          
          if (data.event === 'done') {
            this.handleProcessComplete(data);
          }
        }
        
        handleStageUpdate(data) {
          const stage = data.stage === 'key_points' ? 'keypoints' : data.stage;
          
          // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
          this.setStageStatus(stage, data.status);
          
          // æ·»åŠ æ—¥å¿—
          this.addStageLog(stage, data.status);
          
          // æ›´æ–°è¿›åº¦
          this.updateProgressForStage(stage, data.status);
          
          // å¤„ç†å®Œæˆçš„ç»“æœ
          if (data.status === 'done') {
            console.log(`âœ… é˜¶æ®µå®Œæˆ: ${data.stage}`, data);
            this.updateStageResult(stage, data);
          }
        }
        
        setStageStatus(stage, status) {
          const element = this.elements.statusElements[stage];
          if (!element) return;
          
          element.className = element.className.replace(/\b(pending|active|done|error)\b/g, '');
          if (status) element.classList.add(status);
        }
        
        addStageLog(stage, status) {
          const stageNames = {
            upload: 'æ–‡ä»¶ä¸Šä¼ ', transcribe: 'è¯­éŸ³è½¬å½•', summary: 'ç”Ÿæˆæ‘˜è¦', 
            keypoints: 'æå–è¦ç‚¹', terms: 'æœ¯è¯­è§£é‡Š'
          };
          
          const statusText = {
            pending: 'å‡†å¤‡ä¸­', started: 'å¼€å§‹', active: 'å¤„ç†ä¸­', 
            done: 'å®Œæˆ', error: 'å¤±è´¥'
          }[status] || status;
          
          const type = status === 'error' ? 'error' : status === 'done' ? 'success' : 'info';
          this.addLog(`${stageNames[stage] || stage} ${statusText}`, type);
        }
        
        updateProgressForStage(stage, status) {
          const weight = this.config.stageWeights[stage];
          if (!weight) return;
          
          let increment = 0;
          if (['started', 'active'].includes(status)) increment = weight / 2;
          else if (status === 'done') increment = weight / 2;
          
          this.appState.currentProgress = Math.min(this.appState.currentProgress + increment, 100);
          this.updateProgress(this.appState.currentProgress);
        }
        
          updateStageResult(stage, data) {
          const contentKey = {
            transcribe: 'transcript',
            summary: 'summary', 
            keypoints: 'key_points',
            terms: 'technical_terms'
          }[stage];

          if (stage === 'transcribe') stage = 'transcript';
          console.log('æ›´æ–°é˜¶æ®µç»“æœ:', stage, contentKey, data[contentKey]);
          
          if (!contentKey || !data[contentKey]) return;
          
          const contentElement = this.elements.outputContent[stage];
          const statusElement = this.elements.outputStatus[stage];
          
          if (!contentElement || !statusElement) return;
          
          // å¤„ç†å†…å®¹
          let content = data[contentKey];
          if (Array.isArray(content)) {
            content = content.map(item => `- ${item}`).join('\n');
          }
          
          // æ¸²æŸ“Markdown
          contentElement.innerHTML = TyporaRenderer.render(content);
          contentElement.classList.add('typora-content');
          
          // æ›´æ–°çŠ¶æ€
          statusElement.textContent = 'å·²å®Œæˆ';
          statusElement.style.color = 'var(--success)';
        }
        
        handleProcessComplete(data) {
          this.addLog('æ‰€æœ‰å¤„ç†æ­¥éª¤å·²å®Œæˆ', 'success');
          this.updateProgress(100);
          this.createDownloadButtons(data.results || {});
          this.switchTab('output');
          this.resetSubmitButton();
          
          if (this.appState.eventSource) {
            this.appState.eventSource.close();
            this.appState.eventSource = null;
          }
        }
        
        createDownloadButtons(results) {
          this.clearDownloadButtons();
          
          const downloadConfig = {
            transcript: { content: results.transcript, filename: 'ä¼šè®®è½¬å½•.md', label: 'ä¸‹è½½è½¬å½•' },
            summary: { content: results.summary, filename: 'ä¼šè®®æ‘˜è¦.md', label: 'ä¸‹è½½æ‘˜è¦' },
            keypoints: { content: results.key_points, filename: 'å…³é”®è¦ç‚¹.md', label: 'ä¸‹è½½è¦ç‚¹' },
            terms: { content: results.technical_terms, filename: 'ä¸“ä¸šæœ¯è¯­.md', label: 'ä¸‹è½½æœ¯è¯­' }
          };
          
          Object.keys(downloadConfig).forEach(section => {
            const config = downloadConfig[section];
            if (config.content) {
              this.createDownloadButton(section, config.content, config.filename, config.label);
            }
          });
        }
        
        createDownloadButton(section, content, filename, label) {
          const container = this.elements.downloadContainers[section];
          if (!container) return;
          
          // å¤„ç†å†…å®¹
          let downloadContent = Array.isArray(content) ? 
            content.map(item => `- ${item}`).join('\n') : content;
          
          // åˆ›å»ºä¸‹è½½é“¾æ¥
          const a = document.createElement('a');
          a.className = 'download-btn';
          a.innerHTML = `ğŸ“¥ ${label}`;
          
          const blob = new Blob([downloadContent], { type: 'text/markdown' });
          a.href = URL.createObjectURL(blob);
          a.download = filename;
          
          a.addEventListener('click', () => {
            setTimeout(() => URL.revokeObjectURL(a.href), 100);
          });
          
          container.appendChild(a);
        }
        
        clearDownloadButtons() {
          Object.values(this.elements.downloadContainers).forEach(container => {
            if (container) container.innerHTML = '';
          });
        }
        
        // ==================== å·¥å…·æ–¹æ³• ====================
        
        formatFileSize(bytes) {
          if (bytes === 0) return '0 Bytes';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        updateCurrentTime() {
          if (this.elements.currentTime) {
            this.elements.currentTime.textContent = new Date().toTimeString().split(' ')[0];
          }
        }
        
        resetUI() {
          this.appState.reset();
          this.updateProgress(0);
          
          // é‡ç½®çŠ¶æ€æ˜¾ç¤º
          Object.values(this.elements.statusElements).forEach(element => {
            if (element) element.className = element.className.replace(/\b(pending|active|done|error)\b/g, '');
          });
          
          // æ¸…ç©ºæ—¥å¿—
          if (this.elements.processLog) {
            this.elements.processLog.innerHTML = '';
          }
          this.addLog('ç­‰å¾…å¼€å§‹å¤„ç†...');
          
          // é‡ç½®ç•Œé¢
          this.updateUI();
          this.clearDownloadButtons();
        }
        
        resetSubmitButton() {
          this.elements.submitBtn.disabled = false;
          this.elements.submitBtn.textContent = 'å¼€å§‹å¤„ç†';
        }
      }

      // ==================== åº”ç”¨åˆå§‹åŒ– ====================
      
      document.addEventListener('DOMContentLoaded', () => {
        // åˆ›å»ºå…¨å±€UIç®¡ç†å™¨å®ä¾‹
        window.uiManager = new UIManager();
        
        // æ·»åŠ è°ƒè¯•å·¥å…·
        window.debugUI = () => {
          console.log('UIç®¡ç†å™¨:', window.uiManager);
          console.log('æ˜¯å¦åˆå§‹åŒ–:', window.uiManager.isInitialized);
        };
      });
    </script>
  </body>
</html>