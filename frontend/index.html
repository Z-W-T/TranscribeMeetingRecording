<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ä¼šè®®è½¬å½• Â· å‰ç«¯</title>
    <style>
      :root {
        --bg: #f4f7fb;
        --card: #ffffff;
        --accent: #5b8def;
        --muted: #6b7280;
        --success: #10b981;
        --error: #ef4444;
      }
      
      * { box-sizing: border-box; }
      
      body {
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        background: linear-gradient(180deg, #eef5ff 0%, #fdfefe 100%);
        margin: 0;
        padding: 2rem;
        color: #111;
      }
      
      .container { max-width: 980px; margin: 0 auto; }
      
      header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.25rem;
      }
      
      .logo {
        width: 56px;
        height: 56px;
        background: var(--card);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 18px rgba(91, 141, 239, 0.12);
      }
      
      h1 { font-size: 1.25rem; margin: 0; }
      
      p.lead { color: var(--muted); margin: 0; font-size: 0.95rem; }
      
      .card {
        background: var(--card);
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 6px 20px rgba(12, 24, 48, 0.06);
      }
      
      .grid { display: grid; grid-template-columns: 1fr 360px; gap: 1rem; }
      
      /* é˜¶æ®µ/è¿›åº¦æ ·å¼ */
      .stages {
        display: flex;
        gap: .5rem;
        align-items: center;
        margin-top: .75rem;
      }
      
      .stage {
        display: flex;
        align-items: center;
        gap: .6rem;
        padding: .45rem .6rem;
        border-radius: 10px;
        background: #fbfdff;
        border: 1px solid #eef6ff;
        color: var(--muted);
        font-weight: 600;
        transition: all 0.3s ease;
      }
      
      .stage .icon {
        width: 18px;
        height: 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      
      .stage.pending { background: linear-gradient(90deg, var(--accent), #7fb1ff); color: white; }
      .stage.done { background: linear-gradient(90deg, #10b981, #34d399); color: white; }
      .stage.error { background: var(--error); color: white; border-color: var(--error); }
      .stage.skipped { opacity: 0.4; background: #f3f4f6; color: var(--muted); }
      
      /* è¿›åº¦æ¡ */
      .progress-container {
        width: 100%;
        height: 6px;
        background: #f3f4f6;
        border-radius: 3px;
        margin-top: 1rem;
        overflow: hidden;
      }
      
      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--accent), #7fb1ff);
        border-radius: 3px;
        transition: width 0.5s ease;
        width: 0%;
      }
      
      /* å·¦ä¾§åˆ— */
      .drop-area {
        border: 2px dashed #e6eefc;
        border-radius: 10px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: .75rem;
        align-items: center;
        justify-content: center;
        background: linear-gradient(180deg, rgba(91, 141, 239, 0.02), transparent);
        cursor: pointer;
      }
      
      .drop-area.dragover {
        background: linear-gradient(180deg, rgba(91, 141, 239, 0.06), transparent);
        border-color: var(--accent);
      }
      
      .file-info { width: 100%; display: flex; align-items: center; gap: .75rem; }
      .file-name { font-weight: 600; }
      .muted { color: var(--muted); font-size: .9rem; }
      
      .controls { display: flex; flex-wrap: wrap; gap: .5rem; margin-top: .5rem; }
      
      .toggle {
        display: inline-flex;
        align-items: center;
        gap: .5rem;
        padding: .5rem .6rem;
        border-radius: 8px;
        background: #f7f9ff;
        border: 1px solid #eef3ff;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .toggle svg { width: 18px; height: 18px; opacity: .95; }
      .toggle input { display: none; }
      .toggle.active { background: linear-gradient(90deg, var(--accent), #7fb1ff); color: white; border-color: transparent; }
      .toggle:not(.active) { color: var(--muted); }
      
      .btn {
        background: var(--accent);
        color: white;
        padding: .6rem .9rem;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
      }
      
      .btn:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }
      .btn:disabled { opacity: .6; cursor: default; transform: none; }
      
      /* å³ä¾§åˆ— */
      .aside h3 { margin: .2rem 0 .6rem; }
      
      pre {
        background: #0f1724;
        color: #e6eefc;
        padding: 1rem;
        border-radius: 8px;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 360px;
        overflow: auto;
      }
      
      .status { display: flex; align-items: center; gap: .6rem; color: var(--muted); margin-top: .6rem; }
      
      .spinner {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 3px solid rgba(0, 0, 0, 0.08);
        border-top-color: var(--accent);
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin { to { transform: rotate(360deg); } }
      
      .downloads { display: flex; gap: .5rem; margin-top: .6rem; }
      
      .chip {
        background: #f3f4f6;
        padding: .4rem .6rem;
        border-radius: 999px;
        border: 1px solid #e6e9ef;
        font-weight: 600;
        text-decoration: none;
        color: inherit;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 0.85rem;
      }
      
      .chip:hover { background: #e5e7eb; }
      
      .result-section { margin-bottom: 1rem; }
      .result-section:last-child { margin-bottom: 0; }
      
      /* è½¬å½•è¿›åº¦æ ·å¼ */
      .transcription-progress { margin-top: 0.5rem; font-size: 0.85rem; color: var(--muted); }
      .transcription-progress .bar {
        width: 100%;
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
        margin-top: 4px;
        overflow: hidden;
      }
      
      .transcription-progress .fill {
        height: 100%;
        background: var(--accent);
        border-radius: 2px;
        transition: width 0.3s ease;
      }
      
      /* éšè—æ–‡ä»¶è¾“å…¥ */
      .hidden-input { display: none; }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo" aria-hidden>
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3z" stroke="#5b8def" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19 11v2a7 7 0 0 1-14 0v-2" stroke="#92b6ff" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div>
          <h1>ä¼šè®®è½¬å½•ä¸çºªè¦ç”Ÿæˆ</h1>
          <p class="lead">ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼Œè‡ªåŠ¨è½¬å½•å¹¶ç”Ÿæˆæ‘˜è¦ / è¯¦ç»†çºªè¦ä¸å…³é”®è¦ç‚¹ã€‚</p>
        </div>
      </header>

      <div class="card grid">
        <div>
          <div id="dropArea" class="drop-area" tabindex="0">
            <div style="display:flex;align-items:center;gap:1rem">
              <svg width="44" height="44" viewBox="0 0 24 24" fill="none">
                <path d="M12 3v11" stroke="#5b8def" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 7l4-4 4 4" stroke="#92b6ff" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M20 15a4 4 0 0 1-4 4H8a4 4 0 0 1-4-4" stroke="#cfe0ff" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <div>
                <div class="file-name" id="promptText">æ‹–æ”¾æˆ–ç‚¹å‡»ä»¥é€‰æ‹©éŸ³é¢‘æ–‡ä»¶</div>
                <div class="muted">æ”¯æŒ MP3 / WAVã€‚</div>
              </div>
            </div>
            <input id="fileInput" type="file" accept="audio/*" class="hidden-input" />
          </div>

          <div style="margin-top:0.9rem;display:flex;gap:.75rem;align-items:center">
            <input id="attendees" placeholder="å‚ä¼šäººå‘˜ï¼Œé€—å·åˆ†éš”ï¼ˆå¯é€‰ï¼‰" class="form-input" />
            <input id="meeting_topic" placeholder="ä¼šè®®ä¸»é¢˜ï¼ˆå¯é€‰ï¼‰" class="form-input" style="width:260px" />
          </div>

          <!-- é˜¶æ®µå¯è§†åŒ– -->
          <div class="stages" id="stagesRow">
            <div class="stage" id="stage_upload"><span class="icon">ğŸ“¤</span><span>ä¸Šä¼ </span></div>
            <div class="stage" id="stage_transcribe"><span class="icon">ğŸ™ï¸</span><span>è½¬å½•</span></div>
            <div class="stage" id="stage_summary"><span class="icon">ğŸ“</span><span>æ‘˜è¦</span></div>
            <div class="stage" id="stage_keypoints"><span class="icon">ğŸ”</span><span>è¦ç‚¹</span></div>
            <div class="stage" id="stage_terms"><span class="icon">ğŸ’¡</span><span>æœ¯è¯­</span></div>
          </div>

          <!-- è½¬å½•è¿›åº¦æ¡ -->
          <div class="transcription-progress" id="transcriptionProgress" style="display:none">
            <div>è¯­éŸ³è¯†åˆ«è¿›åº¦: <span id="progressText">0%</span></div>
            <div class="bar"><div class="fill" id="transcriptionProgressBar" style="width:0%"></div></div>
          </div>

          <!-- æ€»ä½“è¿›åº¦æ¡ -->
          <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
          </div>

          <div class="controls">
            <label class="toggle active" id="toggleSummary" title="ç”Ÿæˆæ‘˜è¦">
              <input type="checkbox" id="generate_summary" checked />
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 7h8M8 12h8M8 17h5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              æ‘˜è¦
            </label>

            <label class="toggle active" id="toggleMinutes" title="åŒ…å«å®Œæ•´è½¬å½•">
              <input type="checkbox" id="generate_minutes" checked />
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M4 6h16M4 10h16M4 14h16M4 18h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              å®Œæ•´è½¬å½•
            </label>

            <label class="toggle" id="toggleKeyPoints" title="æå–å…³é”®è¦ç‚¹">
              <input type="checkbox" id="generate_keypoints" />
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M5 12h.01M12 12h7M5 6h.01M12 6h7M5 18h.01M12 18h7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              è¦ç‚¹
            </label>

            <label class="toggle" id="toggleTerms" title="è§£é‡Šä¸“ä¸šæœ¯è¯­">
              <input type="checkbox" id="generate_terms" />
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 2v6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M7 8h10M7 12h10M7 16h7" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              æœ¯è¯­
            </label>

            <button id="submitBtn" class="btn">ä¸Šä¼ å¹¶å¤„ç†</button>
          </div>

          <div class="status" id="statusRow">
            <div class="muted">ç­‰å¾…ä¸Šä¼ </div>
          </div>
          <div style="margin-top:.5rem;color:var(--muted);font-size:.9rem" id="selectedOptions">å·²é€‰ï¼šæ‘˜è¦ã€å®Œæ•´è½¬å½•</div>
        </div>

        <aside class="aside">
          <h3>å¤„ç†è¾“å‡º</h3>
          <div class="card" style="padding:.75rem">
            <!-- ä¸‹è½½é¢æ¿ -->
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.6rem">
              <div class="muted">ä¸‹è½½æ–‡ä»¶</div>
              <div id="downloadPanel" style="display:flex;gap:.5rem;flex-wrap:wrap"></div>
            </div>

            <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
            <div class="result-section">
              <div style="display:flex;gap:.5rem;align-items:center;justify-content:space-between">
                <div class="muted">å®Œæ•´è½¬å½•</div>
                <span id="status_transcript" class="muted" style="font-size:0.8rem"></span>
              </div>
              <pre id="transcript">ï¼ˆç­‰å¾…ç»“æœï¼‰</pre>
            </div>

            <div class="result-section">
              <div style="display:flex;gap:.5rem;align-items:center;justify-content:space-between">
                <div class="muted">æ‘˜è¦</div>
                <span id="status_summary" class="muted" style="font-size:0.8rem"></span>
              </div>
              <pre id="summary">ï¼ˆç­‰å¾…ç»“æœï¼‰</pre>
            </div>

            <div class="result-section">
              <div style="display:flex;gap:.5rem;align-items:center;justify-content:space-between">
                <div class="muted">å…³é”®è¦ç‚¹</div>
                <span id="status_keypoints" class="muted" style="font-size:0.8rem"></span>
              </div>
              <pre id="key_points">ï¼ˆå¦‚é€‰æ‹©ï¼Œå¤„ç†åæ˜¾ç¤ºï¼‰</pre>
            </div>

            <div class="result-section">
              <div style="display:flex;gap:.5rem;align-items:center;justify-content:space-between">
                <div class="muted">ä¸“ä¸šæœ¯è¯­è§£é‡Š</div>
                <span id="status_terms" class="muted" style="font-size:0.8rem"></span>
              </div>
              <pre id="technical_terms">ï¼ˆå¦‚é€‰æ‹©ï¼Œå¤„ç†åæ˜¾ç¤ºï¼‰</pre>
            </div>
          </div>
        </aside>
      </div>

      <footer>æç¤ºï¼šç¡®ä¿åç«¯å·²è¿è¡Œå¹¶è®¾ç½®äº†æ­£ç¡®çš„ API Keyï¼ˆè‹¥ä½¿ç”¨è¿œç¨‹æ¨¡å‹ï¼‰ã€‚</footer>
    </div>

    <script>
      // åº”ç”¨çŠ¶æ€ç®¡ç†å™¨
      class AppState {
        constructor() {
          this.currentProgress = 0;
          this.eventSource = null;
          this.stages = {
            upload: { weight: 10, required: true },
            transcribe: { weight: 40, required: true },
            summary: { weight: 25, optional: true },
            keypoints: { weight: 15, optional: true },
            terms: { weight: 10, optional: true }
          };
        }
        
        reset() {
          this.currentProgress = 0;
          if (this.eventSource) {
            this.eventSource.close();
            this.eventSource = null;
          }
        }
      }

      // UI ç®¡ç†å™¨
      class UIManager {
        constructor() {
          this.elements = {
            dropArea: document.getElementById('dropArea'),
            fileInput: document.getElementById('fileInput'),
            promptText: document.getElementById('promptText'),
            submitBtn: document.getElementById('submitBtn'),
            statusRow: document.getElementById('statusRow'),
            progressBar: document.getElementById('progressBar'),
            downloadPanel: document.getElementById('downloadPanel'),
            transcriptionProgress: document.getElementById('transcriptionProgress'),
            transcriptionProgressBar: document.getElementById('transcriptionProgressBar'),
            progressText: document.getElementById('progressText')
          };
          
          this.resultElements = {
            transcript: document.getElementById('transcript'),
            summary: document.getElementById('summary'),
            key_points: document.getElementById('key_points'),
            technical_terms: document.getElementById('technical_terms')
          };
          
          this.statusElements = {
            transcript: document.getElementById('status_transcript'),
            summary: document.getElementById('status_summary'),
            keypoints: document.getElementById('status_keypoints'),
            terms: document.getElementById('status_terms')
          };
          
          this.initializeEventListeners();
        }
        
        initializeEventListeners() {
          // æ‹–æ”¾äº‹ä»¶
          ['dragenter', 'dragover'].forEach(evt => 
            this.elements.dropArea.addEventListener(evt, this.handleDragOver.bind(this))
          );
          
          ['dragleave', 'drop'].forEach(evt => 
            this.elements.dropArea.addEventListener(evt, this.handleDragLeave.bind(this))
          );
          
          this.elements.dropArea.addEventListener('drop', this.handleDrop.bind(this));
          this.elements.dropArea.addEventListener('click', () => this.elements.fileInput.click());
          this.elements.fileInput.addEventListener('change', this.handleFileSelect.bind(this));
          
          // åˆ‡æ¢æŒ‰é’®äº‹ä»¶
          document.querySelectorAll('.toggle').forEach(toggle => {
            const checkbox = toggle.querySelector('input[type="checkbox"]');
            toggle.addEventListener('click', () => {
              checkbox.checked = !checkbox.checked;
              toggle.classList.toggle('active', checkbox.checked);
              this.updateSelectedOptions();
              this.updateStageVisibility();
            });
          });
          
          // æäº¤æŒ‰é’®äº‹ä»¶
          this.elements.submitBtn.addEventListener('click', this.handleSubmit.bind(this));
          
          // é¡µé¢å¸è½½æ—¶å…³é—­SSEè¿æ¥
          window.addEventListener('beforeunload', () => {
            if (appState.eventSource) {
              appState.eventSource.close();
            }
          });
        }
        
        handleDragOver(e) {
          e.preventDefault();
          this.elements.dropArea.classList.add('dragover');
        }
        
        handleDragLeave(e) {
          e.preventDefault();
          this.elements.dropArea.classList.remove('dragover');
        }
        
        handleDrop(e) {
          e.preventDefault();
          this.elements.dropArea.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length) {
            this.elements.fileInput.files = e.dataTransfer.files;
            this.handleFileSelect();
          }
        }
        
        handleFileSelect() {
          const file = this.elements.fileInput.files[0];
          if (!file) return;
          this.elements.promptText.textContent = `å·²é€‰æ‹©ï¼š${file.name} Â· ${(file.size/1024/1024).toFixed(2)} MB`;
        }
        
        updateSelectedOptions() {
          const opts = [];
          if (document.getElementById('generate_summary').checked) opts.push('æ‘˜è¦');
          if (document.getElementById('generate_minutes').checked) opts.push('å®Œæ•´è½¬å½•');
          if (document.getElementById('generate_keypoints').checked) opts.push('è¦ç‚¹');
          if (document.getElementById('generate_terms').checked) opts.push('æœ¯è¯­');
          document.getElementById('selectedOptions').textContent = 'å·²é€‰ï¼š' + (opts.length ? opts.join('ã€') : 'æ— ');
        }
        
        updateStageVisibility() {
          const stages = {
            summary: document.getElementById('generate_summary').checked,
            keypoints: document.getElementById('generate_keypoints').checked,
            terms: document.getElementById('generate_terms').checked
          };

          Object.keys(stages).forEach(stage => {
            const stageEl = document.getElementById(`stage_${stage}`);
            if (stageEl) {
              if (!stages[stage] && !appState.stages[stage].required) {
                stageEl.classList.add('skipped');
              } else {
                stageEl.classList.remove('skipped');
              }
            }
          });
        }
        
        setStatus(text, busy = false) {
          this.elements.statusRow.innerHTML = busy ? 
            `<div class="spinner"></div><div>${text}</div>` : 
            `<div class="muted">${text}</div>`;
        }
        
        setStageState(stageId, state) {
          const el = document.getElementById(stageId);
          if (!el) return;
          
          el.classList.remove('pending', 'done', 'error', 'skipped');
          
          switch(state) {
            case 'pending': el.classList.add('pending'); break;
            case 'done': el.classList.add('done'); break;
            case 'error': el.classList.add('error'); break;
            case 'skipped': el.classList.add('skipped'); break;
          }
        }
        
        setOptionStatus(optionId, status, text = '') {
          const el = this.statusElements[optionId];
          if (!el) return;
          
          const statusMap = {
            pending: '<span class="spinner" style="width:12px;height:12px;border-width:2px"></span> å¤„ç†ä¸­',
            done: 'âœ… å®Œæˆ',
            error: 'âŒ å¤±è´¥',
            skipped: 'â­ï¸ å·²è·³è¿‡'
          };
          
          el.innerHTML = statusMap[status] || '';
          if (text) el.innerHTML += ' ' + text;
        }
        
        updateProgress(stage, status) {
          if (status === 'started') {
            appState.currentProgress += appState.stages[stage].weight / 2;
          } else if (status === 'done') {
            appState.currentProgress += appState.stages[stage].weight / 2;
          }
          
          this.elements.progressBar.style.width = `${Math.min(appState.currentProgress, 100)}%`;
        }
        
        updateTranscriptionProgress(percent) {
          this.elements.transcriptionProgress.style.display = 'block';
          this.elements.transcriptionProgressBar.style.width = `${percent}%`;
          this.elements.progressText.textContent = `${percent}%`;
          
          if (percent >= 100) {
            setTimeout(() => {
              this.elements.transcriptionProgress.style.display = 'none';
            }, 1000);
          }
        }
        
        resetProgress() {
          appState.currentProgress = 0;
          this.elements.progressBar.style.width = '0%';
          this.elements.transcriptionProgress.style.display = 'none';
          this.elements.transcriptionProgressBar.style.width = '0%';
          this.elements.progressText.textContent = '0%';
          
          // é‡ç½®æ‰€æœ‰é˜¶æ®µçŠ¶æ€
          Object.keys(appState.stages).forEach(stage => {
            this.setStageState(`stage_${stage}`, '');
            this.setOptionStatus(stage, '');
          });
          
          // é‡ç½®ç»“æœåŒºåŸŸ
          Object.keys(this.resultElements).forEach(key => {
            this.resultElements[key].textContent = 
              key === 'transcript' || key === 'summary' ? 
                'ï¼ˆç­‰å¾…ç»“æœï¼‰' : 'ï¼ˆå¦‚é€‰æ‹©ï¼Œå¤„ç†åæ˜¾ç¤ºï¼‰';
          });
          
          this.elements.downloadPanel.innerHTML = '';
          this.updateStageVisibility();
        }
        
        makeDownloadButton(filename, text, label) {
          const a = document.createElement('a');
          const blob = new Blob([text], {type: 'text/markdown;charset=utf-8'});
          a.href = URL.createObjectURL(blob);
          a.download = filename;
          a.className = 'chip';
          
          const icon = document.createElement('span');
          icon.innerHTML = 'ğŸ“¥';
          a.appendChild(icon);
          
          const txt = document.createElement('span');
          txt.textContent = label;
          a.appendChild(txt);
          
          return a;
        }
        
        async handleSubmit() {
          if (!this.elements.fileInput.files.length) {
            alert('è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶');
            return;
          }
          
          // å…³é—­ä¹‹å‰çš„è¿æ¥
          if (appState.eventSource) {
            appState.eventSource.close();
          }
          
          this.elements.submitBtn.disabled = true;
          this.setStatus('ä¸Šä¼ å¹¶å¤„ç†ä¸­...', true);
          this.resetProgress();
          
          const fd = new FormData();
          fd.append('file', this.elements.fileInput.files[0]);
          fd.append('attendees', document.getElementById('attendees').value || '');
          fd.append('meeting_topic', document.getElementById('meeting_topic').value || '');
          fd.append('generate_minutes', document.getElementById('generate_minutes').checked);
          fd.append('generate_summary', document.getElementById('generate_summary').checked);
          fd.append('generate_keypoints', document.getElementById('generate_keypoints').checked);
          fd.append('generate_terms', document.getElementById('generate_terms').checked);

          try {
            const resp = await fetch('/api/process', {method: 'POST', body: fd});
            if (!resp.ok) { 
              const err = await resp.json().catch(() => ({})); 
              this.setStatus('å¤„ç†å¤±è´¥: ' + (err.error || resp.statusText));
              this.elements.submitBtn.disabled = false; 
              return; 
            }

            const { task_id } = await resp.json();
            this.setStatus('ä»»åŠ¡è¿›è¡Œä¸­...', true);

            // è®¾ç½®åˆå§‹è¿›åº¦
            this.setStageState('stage_upload', 'pending');
            this.updateProgress('upload', 'started');

            // æ‰“å¼€SSEè¿æ¥
            appState.eventSource = new EventSource(`/api/events/${task_id}`);
            
            appState.eventSource.onmessage = (event) => {
              try {
                const data = JSON.parse(event.data);
                console.log('SSE Message:', data);
                
                // å¤„ç†è½¬å½•è¿›åº¦æ›´æ–°
                if (data.stage === 'transcribe' && data.progress !== undefined) {
                  this.updateTranscriptionProgress(data.progress);
                  return;
                }
                
                // å¤„ç†é˜¶æ®µæ›´æ–°
                if (data.stage && data.status) {
                  const stage = data.stage === 'key_points' ? 'keypoints' : data.stage;
                  const stageId = `stage_${stage}`;
                  
                  this.setStageState(stageId, data.status);
                  this.setOptionStatus(stage, data.status);
                  this.updateProgress(stage, data.status);
                  
                  // æ›´æ–°å…·ä½“å†…å®¹
                  if (data.status === 'done') {
                    switch(stage) {
                      case 'transcribe':
                        if (data.transcript) {
                          this.resultElements.transcript.textContent = data.transcript;
                        }
                        this.updateTranscriptionProgress(100);
                        break;
                      case 'summary':
                        if (data.summary) {
                          this.resultElements.summary.textContent = data.summary;
                        }
                        break;
                      case 'keypoints':
                        if (data.key_points) {
                          const content = Array.isArray(data.key_points) ? 
                            data.key_points.map(k => `â€¢ ${k}`).join('\n') : 
                            String(data.key_points);
                          this.resultElements.key_points.textContent = content;
                        }
                        break;
                      case 'terms':
                        if (data.technical_terms) {
                          const content = Array.isArray(data.technical_terms) ? 
                            data.technical_terms.map(t => `â€¢ ${t}`).join('\n') : 
                            String(data.technical_terms);
                          this.resultElements.technical_terms.textContent = content;
                        }
                        break;
                    }
                  }
                }
                
                // å¤„ç†å®Œæˆäº‹ä»¶
                if (data.event === 'done') {
                  this.setStatus('å¤„ç†å®Œæˆ');
                  this.elements.progressBar.style.width = '100%';
                  
                  // åˆ›å»ºä¸‹è½½æŒ‰é’®
                  const results = data.results || {};
                  this.elements.downloadPanel.innerHTML = '';
                  
                  // è°ƒæ•´ä¸‹è½½æŒ‰é’®é¡ºåºï¼šå…ˆè½¬å½•åæ‘˜è¦
                  if (results.transcript) {
                    this.elements.downloadPanel.appendChild(
                      this.makeDownloadButton('transcript.md', `# ä¼šè®®è½¬å½•\n\n${results.transcript}`, 'è½¬å½•.md')
                    );
                  }
                  if (results.summary) {
                    this.elements.downloadPanel.appendChild(
                      this.makeDownloadButton('summary.md', `# ä¼šè®®æ‘˜è¦\n\n${results.summary}`, 'æ‘˜è¦.md')
                    );
                  }
                  if (results.key_points) {
                    const content = Array.isArray(results.key_points) ? 
                      results.key_points.map(k => `â€¢ ${k}`).join('\n') : 
                      String(results.key_points);
                    this.elements.downloadPanel.appendChild(
                      this.makeDownloadButton('key_points.md', `# å…³é”®è¦ç‚¹\n\n${content}`, 'è¦ç‚¹.md')
                    );
                  }
                  if (results.technical_terms) {
                    const content = Array.isArray(results.technical_terms) ? 
                      results.technical_terms.map(t => `â€¢ ${t}`).join('\n') : 
                      String(results.technical_terms);
                    this.elements.downloadPanel.appendChild(
                      this.makeDownloadButton('terms.md', `# ä¸“ä¸šæœ¯è¯­\n\n${content}`, 'æœ¯è¯­.md')
                    );
                  }
                  
                  if (appState.eventSource) {
                    appState.eventSource.close();
                    appState.eventSource = null;
                  }
                  this.elements.submitBtn.disabled = false;
                }
                
              } catch (error) {
                console.error('SSEå¤„ç†é”™è¯¯:', error);
              }
            };
            
            appState.eventSource.onerror = (error) => {
              console.error('SSEè¿æ¥é”™è¯¯:', error);
              this.setStatus('è¿æ¥å¼‚å¸¸');
              if (appState.eventSource) {
                appState.eventSource.close();
                appState.eventSource = null;
              }
              this.elements.submitBtn.disabled = false;
            };
            
          } catch (error) {
            this.setStatus('è¯·æ±‚å‡ºé”™: ' + error.message);
            this.elements.submitBtn.disabled = false;
          }
        }
      }

      // åˆå§‹åŒ–åº”ç”¨
      const appState = new AppState();
      const uiManager = new UIManager();
      
      // åˆå§‹åŒ–UIçŠ¶æ€
      uiManager.updateSelectedOptions();
      uiManager.updateStageVisibility();
      
      // æ·»åŠ è¡¨å•è¾“å…¥æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .form-input {
          padding: .6rem;
          border-radius: 8px;
          border: 1px solid #e6eefc;
          flex: 1;
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>